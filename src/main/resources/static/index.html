<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forevo - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        /* --- CSS –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¢–µ–º—ã) --- */
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
            --bg-app: #ffffff;
            --bg-body: #F5F7FA;
            --text-main: #37474F;
            --text-sub: #78909C;
            --primary: #4FC3F7;
            --primary-grad: linear-gradient(135deg, #4FC3F7, #0288D1);
            --sidebar-bg: #F8FDFF;
            --input-bg: #E1F5FE;
            --border: #E1F5FE;
            --msg-in: #FFFFFF;
            --msg-out: linear-gradient(135deg, #4FC3F7, #29B6F6);
            --shadow: 0 10px 40px rgba(3, 169, 244, 0.15);
            --danger: #FF5252;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark-mode {
            --bg-app: #1E293B;
            --bg-body: #0F172A;
            --text-main: #E2E8F0;
            --text-sub: #94A3B8;
            --primary: #38BDF8;
            --primary-grad: linear-gradient(135deg, #0EA5E9, #0284C7);
            --sidebar-bg: #111827;
            --input-bg: #334155;
            --border: #334155;
            --msg-in: #334155;
            --msg-out: linear-gradient(135deg, #0EA5E9, #0284C7);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            --danger: #F87171;
        }

        /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏ –ö–û–ù–¢–ï–ô–ù–ï–† --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background 0.3s;
        }

        .app-container {
            width: 90%;
            max-width: 900px;
            height: 85vh;
            background: var(--bg-app);
            border-radius: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            position: relative;
            transition: background 0.3s, box-shadow 0.3s;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –≠–∫—Ä–∞–Ω—ã --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen {
            flex-grow: 1;
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease-out;
        }

        .screen.active {
            display: flex;
        }

        /* --- –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI --- */
        .form-box { width: 100%; max-width: 400px; padding: 40px; text-align: center; }

        input {
            width: 100%; padding: 15px; margin-bottom: 15px; background: var(--input-bg);
            border: 2px solid transparent; border-radius: 12px; color: var(--text-main);
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: 0.2s transform, 0.2s opacity, 0.2s background;
        }

        .btn-primary {
            background: var(--primary-grad); color: white;
            box-shadow: 0 5px 15px rgba(3, 169, 244, 0.3);
        }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(3, 169, 244, 0.4); }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary { background: transparent; color: var(--text-sub); }
        .btn-secondary:hover { color: var(--primary); background: var(--input-bg); }
        .btn-secondary:active { opacity: 0.8; }

        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; }

        /* --- –ß–∞—Ç –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å --- */
        .chat-layout { display: flex; width: 100%; height: 100%; }

        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-profile-btn {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .my-profile-btn:hover { background: var(--input-bg); }

        .mini-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ —á–∞—Ç–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ (–ù–û–í–´–ô) */
        .chat-item-container { padding: 10px; }
        .chat-item {
            padding: 15px;
            background: var(--input-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .chat-item:hover {
            box-shadow: 0 2px 8px rgba(3, 169, 244, 0.1);
        }
        .chat-item.active {
            background: var(--primary);
            color: white;
        }
        .chat-item.active div { color: white !important; }

        /* --- –°–æ–æ–±—â–µ–Ω–∏—è (–ê–Ω–∏–º–∞—Ü–∏–∏) --- */
        .messages { padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg {
            max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 0.95em; line-height: 1.4; position: relative; cursor: pointer;
            transition: all 0.2s ease-out;
        }
        .msg:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }
        .msg-in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-out { background: var(--msg-out); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-quote { border-left: 3px solid var(--primary); padding-left: 8px; margin-bottom: 5px; font-size: 0.85em; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .msg-reactions { position: absolute; bottom: -15px; right: 0; background: var(--msg-in); border: 1px solid var(--border); border-radius: 15px; padding: 2px 5px; font-size: 0.8em; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ú–µ–Ω—é --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: var(--bg-app);
            padding: 30px;
            border-radius: 12px;
            min-width: 350px;
            box-shadow: var(--shadow);
        }
        .modal-close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-sub); }
        #blur-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 999;
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.1);
        }

        #context-menu {
            position: fixed;
            z-index: 1000;
            background: var(--bg-app);
            border-radius: 10px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            min-width: 200px;
            overflow: hidden;
            display: none;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            transform-origin: top left;
            transform: scale(0.9);
            opacity: 0;
        }
        #context-menu.active {
            display: block;
            transform: scale(1);
            opacity: 1;
        }
        .menu-item { padding: 10px 15px; cursor: pointer; color: var(--text-main); font-size: 0.9em; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .menu-item:hover { background: var(--input-bg); }
        .reply-box { background: var(--input-bg); padding: 8px 10px; border-radius: 8px; border-left: 3px solid var(--primary); margin-bottom: 10px; display: none; position: relative; }
        .typing-indicator { font-size: 0.9em; color: #4CAF50; transition: opacity 0.3s; }

        /* --- –ë–ª–æ–∫ –í–≤–æ–¥–∞ (–§–∏–∫—Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è) --- */
        .input-box {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            gap: 10px;
        }

        .input-box input {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .input-box .btn-primary {
            width: auto;
            margin: 0;
            flex-shrink: 0;
        }

    </style>
</head>
<body onclick="hideContextMenu()">

<div id="blur-overlay" onclick="hideContextMenu()"></div>

<div class="app-container">

    <div id="context-menu" oncontextmenu="return false;">
        <div id="reaction-picker">
            <span onclick="addReaction('üëç')">üëç</span>
            <span onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="addReaction('üòÇ')">üòÇ</span>
            <span onclick="addReaction('üî•')">üî•</span>
            <span onclick="addReaction('‚ùì')">‚ùì</span>
        </div>
        <div class="menu-item" onclick="replyToMessage()">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="menu-item" onclick="copyMessage()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="menu-item menu-item-danger" onclick="deleteMessage('self')">–£–¥–∞–ª–∏—Ç—å (–î–ª—è —Å–µ–±—è)</div>
        <div class="menu-item menu-item-danger" onclick="deleteMessage('all')">–£–¥–∞–ª–∏—Ç—å (–î–ª—è –≤—Å–µ—Ö)</div>
    </div>

    <div id="group-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: flex-end;">
                <button onclick="closeModal('group-modal')" class="modal-close-btn">‚úï</button>
            </div>
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–µ—Å–µ–¥—ã.</p>
            <input type="text" id="new-group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <button class="btn btn-primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="welcome-screen" class="screen">
        <div class="form-box">
            <h1 style="font-size: 3em; color: var(--primary);">Forevo</h1>
            <p>–í–µ—Ä—Å–∏—è 9.0</p>
            <button class="btn btn-primary" onclick="nav('login')">–í–æ–π—Ç–∏</button>
            <button class="btn btn-secondary" onclick="nav('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <div id="login-screen" class="screen">
        <div class="form-box">
            <h2>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</h2>
            <input type="email" id="log-email" placeholder="Email">
            <input type="password" id="log-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <div id="log-error" style="color: var(--danger); font-size: 0.9em; margin-bottom: 10px; display: none;">–û—à–∏–±–∫–∞</div>

            <button class="btn btn-primary" onclick="doLogin()">–í–æ–π—Ç–∏</button>
            <button class="btn btn-secondary" onclick="nav('welcome')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="register-screen" class="screen">
        <div class="form-box">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <p>–®–∞–≥ 1: –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-primary" onclick="doRegister()">–î–∞–ª–µ–µ</button>
            <button class="btn btn-secondary" onclick="nav('welcome')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="onboarding-screen" class="screen">
        <div class="form-box">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <p>–ö–∞–∫ –≤–∞—Å –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ?</p>

            <div class="avatar-upload" onclick="document.getElementById('setup-avatar-file').click()">
                <img src="" id="setup-avatar-preview" class="avatar-preview">
                <div class="avatar-overlay">+</div>
            </div>
            <input type="file" id="setup-avatar-file" style="display: none;" accept="image/*" onchange="previewAvatar(this, 'setup-avatar-preview')">

            <input type="text" id="setup-nick" placeholder="–ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤–∞–Ω)">
            <input type="text" id="setup-user" placeholder="@username">

            <button class="btn btn-primary" onclick="finishOnboarding()">–ì–æ—Ç–æ–≤–æ! –í —á–∞—Ç</button>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="chat-layout">
            <div class="sidebar">
                <div class="header">
                    <div class="my-profile-btn" onclick="nav('settings')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        <img id="my-mini-avatar" src="" class="mini-avatar">
                        <div style="font-size: 0.9em; font-weight: bold; overflow: hidden; text-overflow: ellipsis; max-width: 100px;" id="my-mini-name">User</div>
                        <span>‚öôÔ∏è</span>
                    </div>
                    <div class="new-chat-btn" onclick="openModal('group-modal')">+</div>
                </div>

                <div class="chat-list" id="chat-list" style="overflow-y: auto;">
                    <div class="chat-item-container">
                        <div id="chat-support" class="chat-item active" onclick="switchChat('support')">
                            <div style="width: 40px; height: 40px; background: #607D8B; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; margin-right: 10px;">üõ†</div>
                            <div>
                                <strong>–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</strong>
                                <div style="font-size: 0.8em; color: var(--text-sub);">–í—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div class="header chat-header">
                    <strong style="margin-right: 15px;" id="chat-title">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Forevo</strong>
                    <span id="typing-status" class="typing-indicator" style="opacity: 0;">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                </div>
                <div class="messages" id="msgs-area">
                </div>

                <div class="input-box">
                    <div id="reply-box" class="reply-box">
                        <span style="font-weight: bold;">–û—Ç–≤–µ—Ç –Ω–∞:</span>
                        <div id="reply-box-text" class="reply-box-text"></div>
                        <span class="reply-box-close" onclick="cancelReply()">‚úï</span>
                    </div>
                    <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button class="btn btn-primary" onclick="sendMsg()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-screen" class="screen">
        <div class="form-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button onclick="nav('chat')" style="border: none; background: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
            </div>

            <div class="avatar-upload" onclick="document.getElementById('set-avatar-file').click()">
                <img src="" id="settings-avatar-preview" class="avatar-preview">
                <div class="avatar-overlay">‚úé</div>
            </div>
            <input type="file" id="set-avatar-file" style="display: none;" accept="image/*" onchange="previewAvatar(this, 'settings-avatar-preview')">

            <input type="text" id="set-nick" placeholder="–ò–º—è">
            <input type="text" id="set-user" placeholder="Username">

            <div class="theme-switch" onclick="toggleTheme()">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <span id="theme-icon">üåë</span>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button class="btn btn-secondary" onclick="doLogout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            <button class="btn btn-danger" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

</div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let currentUser = null;
    let nextMsgId = 1;
    let contextTargetMsg = null;
    let replyTargetMsgId = null;
    let currentChatId = 'support';
    let ws = null;

    const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

    // --- WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ---
    function connectWebSocket() {
        ws = new WebSocket("ws://" + location.host + "/chat");

        ws.onopen = () => console.log("WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === "message" && data.chatId === currentChatId) {
                const area = document.getElementById("msgs-area");
                const msgEl = createMsgElement(data.text, data.from !== currentUser?.profile?.nick, data.quoteText);
                area.appendChild(msgEl);
                area.scrollTop = area.scrollHeight;
            }
            if (data.type === "newGroup" && data.userId === currentUser.email) {
                addChatToSidebar(data.chatId, data.name, "üë•", "#FF9800");
            }
        };

        ws.onclose = () => setTimeout(connectWebSocket, 1000);
    }

    // --- UI Navigation ---
    function nav(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(screenId + '-screen');
        if (target) target.classList.add('active');
        if (screenId === 'settings') loadSettingsUI();
        if (screenId === 'chat') loadChatUI();
        hideContextMenu();
        cancelReply();
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ---
    function doRegister() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        if (!email || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ Email –∏ –ø–∞—Ä–æ–ª—å");

        fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password: pass })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentUser = { email, profile: null };
                nav('onboarding');
            } else {
                alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
            }
        });
    }

    function doLogin() {
        const email = document.getElementById('log-email').value;
        const pass = document.getElementById('log-pass').value;
        const err = document.getElementById('log-error');

        fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password: pass })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentUser = data.user;
                if (currentUser.profile) {
                    nav('chat');
                    connectWebSocket();
                } else {
                    nav('onboarding');
                }
            } else {
                err.style.display = 'block';
                err.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
            }
        });
    }

    // --- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ ---
    function finishOnboarding() {
        const nick = document.getElementById('setup-nick').value || "User";
        const username = document.getElementById('setup-user').value || "@user";
        const imgSrc = document.getElementById('setup-avatar-preview').src;
        const avatar = imgSrc.includes("placeholder") ? defaultAvatar : imgSrc;
        const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';

        fetch('/api/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nick, username, avatar, theme })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentUser.profile = { nick, username, avatar, theme };
                connectWebSocket();
                nav('chat');
            }
        });
    }

    // --- –†–∞–±–æ—Ç–∞ —Å —á–∞—Ç–∞–º–∏ ---
    function createGroup() {
        const groupName = document.getElementById('new-group-name').value.trim() || "–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞";
        const newId = 'group_' + Date.now();

        fetch('/api/group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId: newId, name: groupName })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                addChatToSidebar(newId, groupName, "üë•", "#FF9800");
                switchChat(newId);
                closeModal('group-modal');
            }
        });
    }

    function addChatToSidebar(id, name, icon, bg) {
        const chatList = document.getElementById('chat-list');
        const isActive = id === currentChatId ? ' active' : '';
        const itemHTML = `
            <div class="chat-item-container">
                <div id="chat-${id}" class="chat-item${isActive}" onclick="switchChat('${id}')">
                    <div style="width: 40px; height: 40px; background: ${bg}; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; margin-right: 10px;">${icon}</div>
                    <div>
                        <strong>${name}</strong>
                        <div style="font-size: 0.8em; color: var(--text-sub);">–°–æ–∑–¥–∞–Ω–∞ –≤–∞–º–∏</div>
                    </div>
                </div>
            </div>
        `;
        chatList.insertAdjacentHTML('beforeend', itemHTML);
    }

    function switchChat(chatId) {
        if (currentChatId === chatId) return;
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        document.getElementById(`chat-${chatId}`)?.classList.add('active');
        document.getElementById('chat-title').innerText =
            chatId === 'support' ? '–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Forevo' :
            document.getElementById(`chat-${chatId} strong`)?.innerText || '–ß–∞—Ç';

        const area = document.getElementById('msgs-area');
        area.innerHTML = '<div class="msg msg-in">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
        area.scrollTop = area.scrollHeight;

        // –ù–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã fetch(`/api/messages?chatId=${chatId}`)
        setTimeout(() => {
            area.innerHTML = '';
            if (chatId === 'support') {
                const initialMsg = createMsgElement("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.", false, null);
                area.appendChild(initialMsg);
            } else {
                const welcomeMsg = createMsgElement(`–í—ã –æ—Ç–∫—Ä—ã–ª–∏ —á–∞—Ç "${document.getElementById(`chat-${chatId} strong`)?.innerText}". –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!`, false, null);
                area.appendChild(welcomeMsg);
            }
            area.scrollTop = area.scrollHeight;
        }, 500);

        currentChatId = chatId;
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function sendMsg() {
        const input = document.getElementById('msg-input');
        const txt = input.value.trim();
        if (!txt) return;

        const area = document.getElementById('msgs-area');
        const quoteText = replyTargetMsgId ? area.querySelector(`[data-msg-id="${replyTargetMsgId}"]`).innerText : null;

        const msgData = {
            type: "message",
            chatId: currentChatId,
            from: currentUser.profile.nick,
            text: txt,
            quoteText: quoteText
        };

        ws.send(JSON.stringify(msgData));

        const myMsg = createMsgElement(txt, true, quoteText);
        area.appendChild(myMsg);
        area.scrollTop = area.scrollHeight;

        input.value = '';
        cancelReply();
    }

    function createMsgElement(text, isOutgoing, quoteText) {
        const msg = document.createElement('div');
        msg.className = 'msg ' + (isOutgoing ? 'msg-out' : 'msg-in');
        msg.setAttribute('data-msg-id', nextMsgId++);
        msg.oncontextmenu = (e) => showContextMenu(e, msg);

        let content = '';
        if (quoteText) content += `<div class="msg-quote">${quoteText.substring(0, 50)}...</div>`;
        content += text;
        msg.innerHTML = content;
        return msg;
    }

    // --- –ü—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    function loadSettingsUI() {
        const p = currentUser.profile;
        document.getElementById('settings-avatar-preview').src = p.avatar;
        document.getElementById('set-nick').value = p.nick;
        document.getElementById('set-user').value = p.username;
        updateThemeIcon();
    }

    function saveSettings() {
        const nick = document.getElementById('set-nick').value;
        const username = document.getElementById('set-user').value;
        const avatar = document.getElementById('settings-avatar-preview').src;

        fetch('/api/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nick, username, avatar })
        })
        .then(() => {
            currentUser.profile.nick = nick;
            currentUser.profile.username = username;
            currentUser.profile.avatar = avatar;
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            nav('chat');
        });
    }

    function doLogout() {
        currentUser = null;
        document.body.classList.remove('dark-mode');
        nav('welcome');
    }

    // --- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ---
    function showContextMenu(e, msgElement) {
        e.preventDefault();
        contextTargetMsg = msgElement;
        const menu = document.getElementById('context-menu');
        menu.style.left = (e.clientX + 5) + 'px';
        menu.style.top = (e.clientY - 10) + 'px';
        document.getElementById('blur-overlay').style.display = 'block';
        menu.style.display = 'block';
        menu.classList.add('active');
    }

    function hideContextMenu() {
        const menu = document.getElementById('context-menu');
        if (menu.classList.contains('active')) {
            menu.classList.remove('active');
            setTimeout(() => {
                menu.style.display = 'none';
                document.getElementById('blur-overlay').style.display = 'none';
                contextTargetMsg = null;
            }, 200);
        }
    }

    function replyToMessage() {
        if (!contextTargetMsg) return hideContextMenu();
        replyTargetMsgId = contextTargetMsg.getAttribute('data-msg-id');
        const text = contextTargetMsg.innerText.trim().substring(0, 80) + "...";
        document.getElementById('reply-box-text').innerText = text;
        document.getElementById('reply-box').style.display = 'block';
        document.getElementById('msg-input').focus();
        hideContextMenu();
    }

    function cancelReply() {
        replyTargetMsgId = null;
        document.getElementById('reply-box').style.display = 'none';
    }

    function addReaction(emoji) {
        if (!contextTargetMsg) return hideContextMenu();
        let reactions = contextTargetMsg.querySelector('.msg-reactions');
        if (!reactions) {
            reactions = document.createElement('div');
            reactions.className = 'msg-reactions';
            contextTargetMsg.appendChild(reactions);
        }
        reactions.innerText = emoji;
        hideContextMenu();
    }

    // --- –¢–µ–º–∞ ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
        currentUser.profile.theme = theme;
        updateThemeIcon();
        // –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: fetch('/api/theme', { method: 'PUT', body: JSON.stringify({ theme }) })
    }

    function updateThemeIcon() {
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('theme-icon').innerText = isDark ? "‚òÄÔ∏è" : "üåë";
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    document.addEventListener('DOMContentLoaded', () => {
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é: fetch('/api/session')
        nav('welcome');
    });

    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMsg();
    });
</script>

</body>
</html>